# Pyroscope Configuration
# Generated by Ansible - Do not edit manually

# Target modules to load
target: {{ pyroscope_config.target | default('all') }}

# Multi-tenancy configuration
multitenancy_enabled: {{ pyroscope_config.multitenancy_enabled | default(false) | lower }}

# Server configuration
server:
  http_listen_address: {{ pyroscope_config.server.http_listen_address | default('0.0.0.0') }}
  http_listen_port: {{ pyroscope_config.server.http_listen_port | default(4040) }}
  grpc_listen_address: {{ pyroscope_config.server.grpc_listen_address | default('0.0.0.0') }}
  grpc_listen_port: {{ pyroscope_config.server.grpc_listen_port | default(4041) }}
  log_level: {{ pyroscope_config.server.log_level | default('info') }}
  log_format: {{ pyroscope_config.server.log_format | default('logfmt') }}
  graceful_shutdown_timeout: {{ pyroscope_config.server.graceful_shutdown_timeout | default('30s') }}
{% if pyroscope_config.server.tls_cert_path is defined %}
  tls_cert_path: {{ pyroscope_config.server.tls_cert_path }}
{% endif %}
{% if pyroscope_config.server.tls_key_path is defined %}
  tls_key_path: {{ pyroscope_config.server.tls_key_path }}
{% endif %}

# Storage configuration
storage:
  backend: {{ pyroscope_config.storage.backend }}
{% if pyroscope_config.storage.backend == 'filesystem' %}
  filesystem:
    dir: {{ pyroscope_config.storage.filesystem.dir }}
{% elif pyroscope_config.storage.backend == 's3' %}
  s3:
    bucket_name: {{ pyroscope_config.storage.s3.bucket_name }}
{% if pyroscope_config.storage.s3.endpoint is defined %}
    endpoint: {{ pyroscope_config.storage.s3.endpoint }}
{% endif %}
{% if pyroscope_config.storage.s3.region is defined %}
    region: {{ pyroscope_config.storage.s3.region }}
{% endif %}
{% if pyroscope_config.storage.s3.access_key_id is defined %}
    access_key_id: {{ pyroscope_config.storage.s3.access_key_id }}
{% endif %}
{% if pyroscope_config.storage.s3.secret_access_key is defined %}
    secret_access_key: {{ pyroscope_config.storage.s3.secret_access_key }}
{% endif %}
{% if pyroscope_config.storage.s3.insecure is defined %}
    insecure: {{ pyroscope_config.storage.s3.insecure | lower }}
{% endif %}
{% elif pyroscope_config.storage.backend == 'gcs' %}
  gcs:
    bucket_name: {{ pyroscope_config.storage.gcs.bucket_name }}
{% if pyroscope_config.storage.gcs.service_account is defined %}
    service_account: {{ pyroscope_config.storage.gcs.service_account }}
{% endif %}
{% elif pyroscope_config.storage.backend == 'azure' %}
  azure:
    container_name: {{ pyroscope_config.storage.azure.container_name }}
    account_name: {{ pyroscope_config.storage.azure.account_name }}
{% if pyroscope_config.storage.azure.account_key is defined %}
    account_key: {{ pyroscope_config.storage.azure.account_key }}
{% endif %}
{% endif %}

# Distributor configuration
distributor:
{% if pyroscope_config.distributor.pushtimeout is defined %}
  pushtimeout: {{ pyroscope_config.distributor.pushtimeout | default('5s') }}
  {% if pyroscope_config.distributor.pool_config is defined %}
  pool_config:
    {{ pyroscope_config.distributor.pool_config | to_nice_yaml }}
  {% endif %}
  {% if pyroscope_config.distributor.ring is defined %}
  ring:
    {{ pyroscope_config.distributor.ring | to_nice_yaml }}
  {% endif %}
{% endif %}

# Ingester configuration
ingester:
  lifecycler:
    address: {{ pyroscope_config.ingester.lifecycler.address | default('127.0.0.1') }}
    ring:
      kvstore:
        store: {{ pyroscope_config.ingester.lifecycler.ring.kvstore.store | default('inmemory') }}
{% if pyroscope_config.ingester.lifecycler.ring.kvstore.store != 'inmemory' %}
        consul:
          host: {{ pyroscope_config.ingester.lifecycler.ring.kvstore.consul.host | default('localhost:8500') }}
{% endif %}
      replication_factor: {{ pyroscope_config.ingester.lifecycler.ring.replication_factor | default(1) }}
{% if pyroscope_config.ingester.max_global_series_per_user is defined %}
  max_global_series_per_user: {{ pyroscope_config.ingester.max_global_series_per_user }}
{% endif %}

# Querier configuration
querier:
  query_store_after: {{ pyroscope_config.querier.query_store_after | default('0s') }}
{% if pyroscope_config.querier.max_samples is defined %}
  max_samples: {{ pyroscope_config.querier.max_samples }}
{% endif %}

# Query scheduler configuration
query_scheduler:
  max_outstanding_requests_per_tenant: {{ pyroscope_config.query_scheduler.max_outstanding_requests_per_tenant | default(100) }}
{% if pyroscope_config.query_scheduler.grpc_client_config is defined %}
  grpc_client_config:
    max_recv_msg_size: {{ pyroscope_config.query_scheduler.grpc_client_config.max_recv_msg_size | default(104857600) }}
    max_send_msg_size: {{ pyroscope_config.query_scheduler.grpc_client_config.max_send_msg_size | default(104857600) }}
{% endif %}

# Compactor configuration
compactor:
  data_dir: {{ pyroscope_data_dir }}/compactor
{% if pyroscope_config.compactor.compaction_interval is defined %}
  compaction_interval: {{ pyroscope_config.compactor.compaction_interval }}
{% endif %}
{% if pyroscope_config.compactor.max_compaction_parallelism is defined %}
  max_compaction_parallelism: {{ pyroscope_config.compactor.max_compaction_parallelism }}
{% endif %}

# Store gateway configuration (for object storage)
store_gateway:
{% if pyroscope_config.store_gateway.sharding_ring is defined %}
  sharding_ring:
    kvstore:
      store: {{ pyroscope_config.store_gateway.sharding_ring.kvstore.store | default('inmemory') }}
{% endif %}

# Memberlist configuration (for clustering)
{% if pyroscope_config.memberlist is defined %}
memberlist:
  bind_port: {{ pyroscope_config.memberlist.bind_port | default(7946) }}
{% if pyroscope_config.memberlist.join_members is defined and pyroscope_config.memberlist.join_members | length > 0 %}
  join_members:
{% for member in pyroscope_config.memberlist.join_members %}
    - {{ member }}
{% endfor %}
{% endif %}
{% endif %}

# Limits configuration
limits:
  max_label_name_length: {{ pyroscope_config.limits.max_label_name_length | default(1024) }}
  max_label_value_length: {{ pyroscope_config.limits.max_label_value_length | default(2048) }}
  max_label_names_per_series: {{ pyroscope_config.limits.max_label_names_per_series | default(30) }}
{% if pyroscope_config.limits.max_global_series_per_user is defined %}
  max_global_series_per_user: {{ pyroscope_config.limits.max_global_series_per_user }}
{% endif %}
{% if pyroscope_config.limits.max_global_series_per_metric is defined %}
  max_global_series_per_metric: {{ pyroscope_config.limits.max_global_series_per_metric }}
{% endif %}
{% if pyroscope_config.limits.ingestion_rate is defined %}
  ingestion_rate: {{ pyroscope_config.limits.ingestion_rate }}
{% endif %}
{% if pyroscope_config.limits.ingestion_burst_size is defined %}
  ingestion_burst_size: {{ pyroscope_config.limits.ingestion_burst_size }}
{% endif %}
{% if pyroscope_config.limits.max_query_length is defined %}
  max_query_length: {{ pyroscope_config.limits.max_query_length }}
{% endif %}
{% if pyroscope_config.limits.max_query_lookback is defined %}
  max_query_lookback: {{ pyroscope_config.limits.max_query_lookback }}
{% endif %}

# Analytics configuration
{% if pyroscope_config.analytics is defined %}
analytics:
  reporting_enabled: {{ pyroscope_config.analytics.reporting_enabled | default(true) | lower }}
{% endif %}

# API configuration
{% if pyroscope_config.api is defined %}
api:
{% if pyroscope_config.api.base_url is defined and pyroscope_config.api.base_url != "" %}
  base_url: {{ pyroscope_config.api.base_url }}
{% endif %}
{% endif %}

# Authentication configuration
{% if pyroscope_config.auth is defined %}
auth:
{% if pyroscope_config.auth.enabled is defined %}
  enabled: {{ pyroscope_config.auth.enabled | lower }}
{% endif %}
{% endif %}
